<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby Super Trunfo Sat</title>
</head>

<body>
    <div id="message" style="visibility: hidden;"><span style="visibility: hidden;">-</span></div> <!--Para exibir mensagens-->
    <div id="header"></div>
    <div id="container"></div>
    <!-- <form id="teste">
        <input id="msg"></input><button>Enviar</button>
    </form> -->

    <script type="module"> //não usado por enquanto
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
        import { getDatabase } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBagkX85yzo0iVzSwELOAF32cRN9QGq6yo",
            authDomain: "supertrunfosat.firebaseapp.com",
            databaseURL: "https://supertrunfosat-default-rtdb.firebaseio.com",
            projectId: "supertrunfosat",
            storageBucket: "supertrunfosat.appspot.com",
            messagingSenderId: "893775498960",
            appId: "1:893775498960:web:e98bcf18a2a3acd9ebd8d5"
        };

        const app = initializeApp(firebaseConfig);
    </script>
    <script>
        const NUM_SALAS = 3;
        let sou_host_sala = false;
        let tentativas_conecatar = 10;
        let idTimeOutMensagem;
        const host = sessionStorage.getItem('ip_host'); //isso irá mudar na hospedagem real
        let socket;
        function exibe_mensagem(msg){
            clearTimeout(idTimeOutMensagem);
            const campo_messagem = document.getElementById("message");
            campo_messagem.innerHTML = msg;
            campo_messagem.style.visibility = "visible";
            idTimeOutMensagem = setTimeout(()=>{campo_messagem.innerHTML='<span style="visibility: hidden;">-</span>'; campo_messagem.style.visibility="hidden"}, 4000);
        }
        function envia_mensagem_servidor(obj){
            const string_mensagem = JSON.stringify(obj);
            if(socket && socket.readyState === WebSocket.OPEN){
                socket.send(string_mensagem)
            } else {
                exibe_mensagem("Erro de conexão");
                reconectar();
            }
        }
        function solicita_inicio_jogo(e){
            const idButton = e.target.id;
            const localizacao = idButton.split("_"); //elemento 1 é a sala, elemento 2 é a cadeira
            envia_mensagem_servidor({
                type: "solicita_inicio_game",
                room: localizacao[1],
                page: "lobby"
            });
        }
        function solicita_cadeira(e){
            const idButton = e.target.id;
            const localizacao = idButton.split("_"); //elemento 1 é a sala, elemento 2 é a cadeira
            envia_mensagem_servidor({
                type: "solicita_cadeira",
                room: localizacao[1],
                chair: localizacao[2],
                page: "lobby"
            });
        }
        function atualiza_todas_cadeiras(cadeiras, ocupadas){
            console.log(cadeiras);
            for(let i=1; i<=NUM_SALAS; i++){
                for(let j=1; j<=6; j++){
                    let botao_atualizando = document.getElementById(`button_${i}_${j}`);
                    botao_atualizando.classList.remove("eu_ocupo");
                    if(cadeiras[i-1][j-1]){
                        botao_atualizando.innerText = cadeiras[i-1][j-1];
                        botao_atualizando.classList.remove("ninguem_ocupando");
                        botao_atualizando.classList.add("alguem_ocupa");
                    } else {
                        botao_atualizando.innerText = "Livre";
                        botao_atualizando.classList.add("ninguem_ocupando");
                        botao_atualizando.classList.remove("alguem_ocupa");
                    }
                }
            }
            console.log("VEtor de salas ocupadas"); //ajustar isso para ocultar as salas ocupadas. Será um vetor
            console.log(ocupadas); //ajustar isso para ocultar as salas ocupadas. Será um vetor
        }
        function build_rooms(){
            const father = document.getElementById("container");
            for(let i=1; i<=NUM_SALAS; i++){
                let newRoom = document.createElement('div');
                newRoom.id = `divRoom_${i}`;
                newRoom.classList.add("div_rooms");
                father.appendChild(newRoom);
                let newSpan = document.createElement('span');
                newRoom.appendChild(newSpan);
                newSpan.innerText = "Sala: " + i;
                newSpan.classList.add("titulo_sala");


                newSpan = document.createElement('span');
                newRoom.appendChild(newSpan);
                for(let j=1; j<=6; j++){
                    let newButton = document.createElement('button');
                    newSpan.appendChild(newButton);
                    newButton.innerText = `Livre`;
                    newButton.classList.add("botao_comum");
                    newButton.id = `button_${i}_${j}`;
                    newButton.classList.add("ninguem_ocupando");
                    newButton.addEventListener('click', solicita_cadeira);
                }
                newSpan = document.createElement('span');
                newRoom.appendChild(newSpan);
                newButton = document.createElement('button');
                newSpan.appendChild(newButton);
                newButton.innerText = `Inciar Jogo`;
                newButton.classList.add("botao_iniciar");
                newButton.id = `buttonStart_${i}`;
                newButton.addEventListener('click', solicita_inicio_jogo);
                newSpan.id = `spanStart_${i}`;
                newSpan.style.visibility = 'hidden';
            }
        }
        function desautenticado_para_pagina_login() {
            const mensagem = "<p style='font-size: 24px; background-color: black; color: red; text-align: center;'>É necessário estar autenticado para jogar. Redirecionamento para página principal.</p>";
            exibe_mensagem(mensagem);
            setTimeout(() => window.location.href = 'index.html', 4000);
        }
        function connect(host) {
            const token = sessionStorage.getItem('token');
            if (!token || !host) { //o jogador precisa ter token e saber o host
                desautenticado_para_pagina_login();
                return;
            }

            socket = new WebSocket(`ws://${host}:8080`);
            socket.addEventListener('open', () => {
                console.log('Connected to the WebSocket server');
                envia_mensagem_servidor({ //padrão de envio de objetos
                    type: "login",
                    token: token,
                    page: "lobby"
                });
            });

            socket.addEventListener('message', (event) => { //não usado ainda
                const objeto = JSON.parse(event.data);
                const type = objeto.type;
                console.log("vet1");
                console.log(objeto.ocupadas);
                if (type == 'Invalid token') { //recebeu a negativa da atutenticação ao entrar na página
                    alert("token existente errado");
                    desautenticado_para_pagina_login();
                } else if (type == 'atualiza_cadeiras') { //no inicio, recebe o estado das cadeiras ao passar da autenticação
                    console.log(objeto.cadeiras);
                    atualiza_todas_cadeiras(objeto.cadeiras, objeto.ocupadas);
                }
                 else if (type == 'avisa_cadeira_ocupada'){
                    const display_message = `Essa cadeira já está sendo ocupada por: <font color="red">${objeto.ocupante_atual}</red>`;
                    exibe_mensagem(display_message);
                 }
                 else if (type == 'jogadores_insuficientes'){
                    const display_message = `É necessário ter o número suficiente de jogadores para iniciar a partida`;
                    exibe_mensagem(display_message);
                 }
                 else if (type == "cadeira_liberada"){ //IMPLEMENTAR A LÓGICA DE DESOCUPAR A CADEIRA
                    console.log(`cadeira liberada da sala ${objeto.room} de numero ${objeto.chair} foi liberada`);
                    let cadeira_selecionada = document.getElementById(`button_${objeto.room}_${objeto.chair}`);
                    cadeira_selecionada.innerText = "Livre";
                    cadeira_selecionada.classList.remove("cadeira_ocupada");
                    cadeira_selecionada.classList.add("ninguem_ocupando");
                    let spanStart = document.getElementById(`spanStart_${objeto.room}`);
                    spanStart.style.visibility = "hidden";
                 }
                 else if (type == "cadeira_ocupada"){
                    console.log(`a cadeira da sala ${objeto.room} numero ${objeto.chair} está sendo ocupado por ${objeto.userNick}`);
                    let cadeira_selecionada = document.getElementById(`button_${objeto.room}_${objeto.chair}`);
                    cadeira_selecionada.innerText = objeto.userNick;
                    cadeira_selecionada.classList.remove("ninguem_ocupando");
                    if(objeto.userNick === sessionStorage.getItem("user")){
                        cadeira_selecionada.classList.add("cadeira_eu_ocupo");
                        if(Number(objeto.chair) == 1){
                            let spanStart = document.getElementById(`spanStart_${objeto.room}`);
                            spanStart.style.visibility = "visible";
                        }
                    } else {
                        cadeira_selecionada.classList.add("cadeira_ocupada");
                    }
                 }
                 else if (type === "partida_inicializada"){ //partida pronta
                    //alert(` partida foi inicializada para vc na sala ${objeto.room} na posição ${objeto.position} com o módulo ${objeto.mode}`);
                    sessionStorage.setItem("room", objeto.room);
                    sessionStorage.setItem("position", objeto.position);
                    sessionStorage.setItem("mode", objeto.mode);
                    setTimeout(() => window.location.href = 'game.html', 4000);
                    const mensagem = `<span style="background-color: darkgreen; color: lightgreen; text-align: center; border-radius: 5px;">Sua partida está sendo inicializada! Sala: ${objeto.room}, Posição: ${objeto.position} na modularidade <strong style="color: yellow;">${objeto.mode}</strong> cartas</span>`;
                    exibe_mensagem(mensagem);
                 }
                 else if (type === "sala_sendo_ocupada"){
                    const sala_ocupada = document.getElementById(`divRoom_${objeto.room}`);
                    sala_ocupada.style.visibility = "hidden";
                 }
                 else if (type === "sala_sendo_desocupada"){
                    const sala_ocupada = document.getElementById(`divRoom_${objeto.room}`);
                    sala_ocupada.style.visibility = "visible";
                 }

            });

            socket.addEventListener('close', () => {
                tentativas_conecatar = 10;
                reconectar();
            });
        }
        function reconectar(){
            if(tentativas_conecatar-- > 0){
                if(socket && socket.readyState === WebSocket.OPEN){
                    tentativas_conecatar = 10; //reseta as tentativas para a próxima vez
                    exibe_mensagem("<font color='green'>Conectado");
                } else {
                    if(tentativas_conecatar < 9){
                        exibe_mensagem(`<font color="red">Problema na conexão! Tentando reconectar (${tentativas_conecatar})</font>`);
                        connect(host);
                    }
                    setTimeout(reconectar, 4000);
                }
            } else { // perdeu a conecção consistentemente
                window.location.href = 'index.html'
            }
        }
        connect(host);
        setTimeout(reconectar, 300); //para testar a conexão ou tentar denovo
        build_rooms();
    </script>
</body>

</html>