<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Super Trunfo Sat</title>
</head>

<body>
    <div id="container">
        <button id="teste_envio">Testa envio</button> <!--DELETAR TESTE DE COMUNICAÇÃO-->
        <button id="teste_derrota">Clicou, perdeu</button> <!--DELETAR TESTE DE COMUNICAÇÃO-->
    </div>

    <script>
        let tentativas_conecatar = 10;
        let idTimeOutMensagem;
        const host = sessionStorage.getItem('ip_host'); //isso irá mudar na hospedagem real
        let socket;
        function envia_mensagem_servidor(obj) {
            const string_mensagem = JSON.stringify(obj);
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(string_mensagem)
            } else {
                console.log("Erro de conexão");
                reconectar();
            }
        }
        function desautenticado_para_pagina_login() {
            const mensagem = "<p style='font-size: 24px; background-color: black; color: red; text-align: center;'>É necessário estar autenticado para jogar. Redirecionamento para página principal.</p>";
            console.log(mensagem);
            setTimeout(() => window.location.href = 'index.html', 4000);
        }
        function connect(host) {
            const token = sessionStorage.getItem('token');
            if (!token || !host) { //o jogador precisa ter token e saber o host
                desautenticado_para_pagina_login();
                return;
            }

            socket = new WebSocket(`ws://${host}:8080`);
            socket.addEventListener('open', async() => {
                console.log('Connected to the WebSocket server');
                await envia_mensagem_servidor({ //o primeiro é para se autenticar e entrar no handler correto
                    type: "login",
                    token: token,
                    page: "game"
                });
                setTimeout(()=>envia_mensagem_servidor({type: "amIPlaying"}), 500);
            });

            socket.addEventListener('message', (event) => { //não usado ainda
                const objecto = JSON.parse(event.data);
                switch (objecto.type) {
                    case 'Invalid token':
                        // Recebeu a negativa da autenticação ao entrar na página
                        alert("token existente errado");
                        desautenticado_para_pagina_login();
                        break;
                    case 'pagina_errada':
                        alert("voce esta na pagina errada"); //DELETAR
                        setTimeout(()=> window.location.href = 'lobby.html', 4000);
                        break;
                    case 'game_over_win':
                        // Mensagem de vitória
                        alert("Parabéns! Você venceu a partida");
                        setTimeout(()=> window.location.href = 'lobby.html', 4000);
                        break;
                    case 'game_over_lose':
                        // Mensagem de derrota
                        alert("Que pena! Você perdeu a partida");
                        window.location.href = 'lobby.html';
                        break;
                    case 'out_of_game':
                        window.location.href = 'lobby.html';
                        break;
                    default:
                        console.log(type);
                        console.log('out_of_game');
                        break;
                }

            });

            socket.addEventListener('close', () => {
                tentativas_conecatar = 12;
                reconectar();
            });
        }
        function reconectar(){
            if(tentativas_conecatar-- > 0){
                if(socket && socket.readyState === WebSocket.OPEN){ //falso positivo quando volta
                            tentativas_conecatar = 12; //reseta as tentativas para a próxima vez
                            exibe_mensagem("<font color='green'>Conectado</font>");
                            PingPong = false;
                } else {
                    if(tentativas_conecatar < 11){
                        if (tentativas_conecatar < 10){
                            exibe_mensagem(`<font color="red">Problema na conexão! Tentando reconectar... (${tentativas_conecatar})</font>`);
                        }
                        connect(host);
                    }
                    setTimeout(reconectar, (13 - tentativas_conecatar)*500);
                }
            } else { // perdeu a conexão consistentemente
                window.location.href = 'index.html';
            }
        }
        connect(host);
        setTimeout(reconectar, 100); //para testar a conexão ou tentar denovo
        document.getElementById('teste_envio').addEventListener('click', ()=>{ //DELETAR, teste de comunicação
            envia_mensagem_servidor("estou ativo na sala do game");
        });
        document.getElementById('teste_derrota').addEventListener('click', ()=>{ //DELETAR, teste de comunicação
            envia_mensagem_servidor({type: "teste_derrota"});
        });
    </script>
</body>

</html>