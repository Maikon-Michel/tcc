<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/game.css">
    <title>Super Trunfo Sat</title>
</head>

<body>
    <div id="message" class="message-hidden"><span>-</span></div> <!--Para exibir mensagens-->
    <div id="container">
        <button id="teste_envio">Testa envio</button> <!--DELETAR TESTE DE COMUNICAÇÃO-->
        <button id="teste_derrota">Clicou, perdeu</button> <!--DELETAR TESTE DE COMUNICAÇÃO-->
        <div id="bnt_teste"></div>
    </div>

    <script>
        let tentativas_conecatar = 10;
        let idTimeOutMensagem;
        const host = sessionStorage.getItem('ip_host'); //isso irá mudar na hospedagem real
        let socket;
        function envia_mensagem_servidor(obj) {
            const string_mensagem = JSON.stringify(obj);
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(string_mensagem);
            } else {
                console.log("Erro de conexão");
                reconectar();
            }
        }
        function add_bnt_teste(){
            pai = document.getElementById("bnt_teste");
            for(let i =0; i<5; i++){
                novoFilho = document.createElement('button');
                novoFilho.value = i;
                novoFilho.innerHTML = `Atributo ${i}`;
                novoFilho.addEventListener('click', ()=>{
                    envia_mensagem_servidor({
                        type: "play",
                        atributo: i
                    });
                });
                pai.appendChild(novoFilho);
            }
        }
        function add_listeners(){
            document.getElementById('teste_envio').addEventListener('click', ()=>{ //DELETAR, teste de comunicação
            envia_mensagem_servidor({type: "play"});
            });
            document.getElementById('teste_derrota').addEventListener('click', ()=>{ //DELETAR, teste de comunicação
                envia_mensagem_servidor({type: "teste_derrota"});
            });
        }

        function exibe_mensagem(msg){ //duplo
            clearTimeout(idTimeOutMensagem);
            const campo_messagem = document.getElementById("message");
            campo_messagem.innerHTML = msg;
            campo_messagem.classList.remove("message-hidden");
            campo_messagem.classList.add("message-visible");
            idTimeOutMensagem = setTimeout(()=>{
                campo_messagem.innerHTML='<span>-</span>';
                campo_messagem.classList.remove("message-visible");
                campo_messagem.classList.add("message-hidden");
            }, 4000);
        }

        function desautenticado_para_pagina_login() {
            const mensagem = "<p style='font-size: 24px; background-color: black; color: red; text-align: center;'>É necessário estar autenticado para jogar. Redirecionamento para página principal.</p>";
            console.log(mensagem);
            setTimeout(() => window.location.href = 'index.html', 4000);
        }
        function connect(host) {
            const token = sessionStorage.getItem('token');
            if (!token || !host) { //o jogador precisa ter token e saber o host
                desautenticado_para_pagina_login();
                return;
            }

            socket = new WebSocket(`ws://${host}:8080`);
            socket.addEventListener('open', async() => {
                console.log('Connected to the WebSocket server');
                await envia_mensagem_servidor({ //o primeiro é para se autenticar e entrar no handler correto
                    type: "login",
                    token: token,
                    page: "game"
                });
                setTimeout(()=>envia_mensagem_servidor({type: "amIPlaying"}), 500);
            });

            socket.addEventListener('message', (event) => { //não usado ainda
                const objecto = JSON.parse(event.data);
                switch (objecto.type) {
                    case 'Invalid token':
                        // Recebeu a negativa da autenticação ao entrar na página
                        alert("token existente errado");
                        desautenticado_para_pagina_login();
                        break;
                    case 'pagina_errada':
                        exibe_mensagem(`<font color="red">Você precisa escolher uma posição para iniciar uma partida...</font>`);
                        setTimeout(()=> window.location.href = 'lobby.html', 1000);
                        break;
                    case 'carta_inicial':
                        console.log(objecto.card);
                        break;
                    case 'change_turn':
                        console.log("objecto.last");
                        console.log(objecto.last);
                        console.log("objecto.next");
                        console.log(objecto.next);
                        console.log("objecto.size");
                        console.log(objecto.size);
                        break;
                    case 'game_over_win': //PRECISA DE DESENVOLVIMENTO
                        // Mensagem de vitória
                        exibe_mensagem(`<font color="green">Parabéns! Você venceu a partida.</font>`);
                        setTimeout(()=> window.location.href = 'lobby.html', 5000);
                        break;
                    case 'game_over_lose': //PRECISA DE DESENVOLVIMENTO
                        // Mensagem de derrota
                        exibe_mensagem(`<font color="red">Que pena! Você perdeu a partida</font>`);
                        setTimeout(()=> window.location.href = 'lobby.html', 5000);
                        break;
                    case 'out_of_game':
                        window.location.href = 'lobby.html';
                        break;
                    default:
                        console.log(objeto);
                        break;
                }

            });

            socket.addEventListener('close', () => {
                tentativas_conecatar = 12;
                reconectar();
            });
        }
        function reconectar(){
            if(tentativas_conecatar-- > 0){
                if(socket && socket.readyState === WebSocket.OPEN){ //falso positivo quando volta
                            tentativas_conecatar = 12; //reseta as tentativas para a próxima vez
                            exibe_mensagem("<font color='green'>Conectado</font>");
                            PingPong = false;
                } else {
                    if(tentativas_conecatar < 11){
                        if (tentativas_conecatar < 10){
                            exibe_mensagem(`<font color="red">Problema na conexão! Tentando reconectar... (${tentativas_conecatar})</font>`);
                        }
                        //socket.close();
                        connect(host);
                    }
                    setTimeout(reconectar, (13 - tentativas_conecatar)*500);
                }
            } else { // perdeu a conexão consistentemente
                window.location.href = 'index.html';
            }
        }
        setTimeout(()=>connect(host), 100); //GAMBIARRA A SER CORRIGIDA! por algum motivo a primeira atualização não funciona para quem volta do jogo
        setTimeout(reconectar, 1000); //para testar a conexão ou tentar denovo
        add_listeners();
        add_bnt_teste();
    </script>
</body>

</html>